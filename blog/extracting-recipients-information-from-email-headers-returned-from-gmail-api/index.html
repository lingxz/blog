<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta content="text/html; charset=utf-8" http-equiv="content-type"><title>Extracting recipients information from email headers returned from Gmail API - theconfused.me</title><meta content="Extracting recipients information from email headers returned from Gmail API - theconfused.me" property="title"><meta content="Extracting recipients information from email headers returned from Gmail API - theconfused.me" property="og:title"><meta property="og:description" content="In a recent side project I needed to figure out a way to properly extract the recipients list from the Gmail API response. In the end I managed to do it with some regex and this is just a post documenting how I did it."><meta property="og:type" content="article"><meta property="og:url" content="https://theconfused.me/blog/extracting-recipients-information-from-email-headers-returned-from-gmail-api/"><meta property="article:published_time" content="2017-08-07T00:00:00&#43;00:00"><meta name="generator" content="Hugo 0.57.2"><style type="text/css">:root{--main-color:#4c4e4f;--secondary-color:cornflowerblue;--logo-text-color:#fff;--heading-text-color:#4c4e4f;--body-text-color:#4c4e4f;--background-color:#fdfdff}body,html{color:#303030;font-family:Helvetica,Arial,sans-serif;font-size:15px;letter-spacing:.02em}#toc,.post-content{line-height:1.5}h1,h2{font-size:1.5rem}h3,strong{font-size:1rem}h1:focus,h2:focus,h3:focus,h4:focus{outline:0}.main{max-width:650px;margin:0 auto;padding:1rem}.container{position:relative}.logo{font-size:1.5rem;font-weight:600;color:var(--secondary-color)}a{color:inherit;text-decoration:none;transition:.1s color linear,.1s border-color linear}a:hover:not(.logo){color:var(--secondary-color)}.article a{border-bottom:1px solid rgba(48,48,48,.4)}.article a:hover{border-bottom-color:var(--secondary-color)}hr{border:0;border-top:1px dashed rgba(48,48,48,.18)}.gap-top{margin-top:1.65rem}.posts-list{display:flex;margin-top:1rem}.posts-list strong{margin-left:.66rem}.date{min-width:60px;text-align:right}.faded{color:rgba(48,48,48,.4);font-style:italic;font-weight:700}pre{font-size:.9em;padding:10px 20px 10px 20px;overflow:auto;line-height:1.25em}p code{font-weight:700}.message{font-weight:400}@media only screen and (min-width:875px){.main{padding:3rem 1rem;padding:bottom: 5rem}}figure{margin:2em 1em}img{display:block;margin-left:auto;margin-right:auto;box-shadow:1px 1px 2px 2px #bbb;max-width:100%}figure.no-border img{box-shadow:none}figure.img-wide img{margin-left:-100px;margin-right:-100px;max-width:850px}@media (max-width:850px){figure.img-wide img{margin-left:0;margin-right:0;max-width:100%}}figcaption{text-align:center;margin-top:.5em;color:gray}blockquote{border-left-style:solid;border-left-width:1px;border-color:rgba(48,48,48,.18);border-width:.25rem;margin-left:0;margin-top:0;margin-right:0;padding-left:1rem}blockquote p{color:#666;margin-top:0;font-style:italic}blockquote p>cite{text-transform:uppercase;font-style:normal;letter-spacing:.1em;font-size:.875rem;display:block}table{font-size:14px;border-collapse:collapse;margin:2rem auto;padding:0}table tr{border-top:1px solid #ccc;margin:0;padding:0}table tr td[align=center],table tr th[align=center]{text-align:center}table tr td,table tr th{border:1px solid #ccc;text-align:left;margin:0;padding:6px 13px}#toc{position:fixed}#toc>.toc-list{max-width:250px;overflow:hidden;position:fixed;right:2rem}@media (min-width:1200px){#toc>.toc-list{display:block;top:100px}}@media (min-width:1330px){#toc>.toc-list{max-width:300px;right:3rem}}#toc ol{list-style:none}.gray{color:rgba(48,48,48,.4);font-weight:700}</style><link rel="icon" href="https://theconfused.me/favicon.ico" type="image/x-icon"><link href="https://theconfused.me/feed.xml" rel="alternate" type="application/atom+xml" title="theconfused.me"><script type="application/javascript">var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-96137027-1","auto"),ga("send","pageview"))</script><script async src="https://www.google-analytics.com/analytics.js"></script></head><body><div class="main"><div class="container" class="article gap-top-container"><div style="margin-bottom:1.5rem"><a class="logo" href="https://theconfused.me/">theconfused.me</a></div><span class="gray">07 Aug 2017 { <a href="https://theconfused.me/tags/js">js</a> <a href="https://theconfused.me/tags/gmail">gmail</a> <a href="https://theconfused.me/tags/re">re</a> }</span><h1>Extracting recipients information from email headers returned from Gmail API</h1><div class="post-content article"><p>In a recent side project I needed to figure out a way to properly extract the recipients list from the Gmail API response. In the end I managed to do it with some regex and this is just a post documenting how I did it.</p><p>From the <a href="https://developers.google.com/gmail/api/v1/reference/" target="_blank">Gmail API documentation</a>, when you send a get request to the Gmail API for a particular <code>userId</code> and <code>messageId</code>, it returns a <a href="https://developers.google.com/gmail/api/v1/reference/users/messages#resource" target="_blank">Users.message resource</a> which looks something like this:</p><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">{
  &#34;id&#34;: string,
  &#34;threadId&#34;: string,
  &#34;labelIds&#34;: [
    string
  ],
  &#34;snippet&#34;: string,
  &#34;historyId&#34;: unsigned long,
  &#34;internalDate&#34;: long,
  &#34;payload&#34;: {
    &#34;partId&#34;: string,
    &#34;mimeType&#34;: string,
    &#34;filename&#34;: string,
    &#34;headers&#34;: [
      {
        &#34;name&#34;: string,
        &#34;value&#34;: string
      }
    ],
    &#34;body&#34;: users.messages.attachments Resource,
    &#34;parts&#34;: [
      (MessagePart)
    ]
  },
  &#34;sizeEstimate&#34;: integer,
  &#34;raw&#34;: bytes
}</pre></div><p>The recipients can be obtained from the <code>headers</code> field, by taking the value corresponding to &quot;to&quot; in the name. Usually, with multiple recipients, the value looks something like this:</p><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&#34;John Miranda&#34; &lt;john@gmail.com&gt;, &#34;Doe, Emily&#34; &lt;emilydoe@gmail.com&gt;, something@example.com</pre></div><p>The recipients are comma separated and for each recipient there are 2 main formats it can come in:</p><ul><li>&quot;Name&quot; &lt;email address&gt;</li><li>email address</li></ul><p>There are a few things that has to be taken into account that makes the problem not so simple:</p><ul><li>if name is present, email address is enclosed in angular brackets</li><li>otherwise, email address appears alone, without the angular brackets</li><li>name is enclosed by quotation marks if there is a comma in the name</li></ul><p>The end goal is to extract the recipients information from this response into an array with each item of the array being a dictionary containing the name and email of the sender, if they exist. It is obvious that we cannot simply split the string by commas, since there might also be a comma in the name.</p><p>The following javascript regex takes the above considerations into account and, as far as I've tested it, splits the string properly:</p><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:700">function</span> <span style="color:#000">parseEmailRecipients</span><span style="color:#000;font-weight:700">(</span><span style="color:#000">recipientString</span><span style="color:#000;font-weight:700">)</span> <span style="color:#000;font-weight:700">{</span>

  <span style="color:#8f5902;font-style:italic">// an example string:
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// const str = `&#34;John Miranda&#34; &lt;john@gmail.com&gt;, &#34;Doe, Emily&#34; &lt;emilydoe@gmail.com&gt;, something@example.com, John Doe &lt;something@gmail.com&gt;, `;
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:700">const</span> <span style="color:#000">regex</span> <span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#4e9a06">/(([\w,\&#34;\s]+)\s)?&lt;?([^@&lt;\s]+@[^@\s&gt;]+)&gt;?,/g</span><span style="color:#000;font-weight:700">;</span>
  <span style="color:#204a87;font-weight:700">let</span> <span style="color:#000">m</span><span style="color:#000;font-weight:700">;</span>
  <span style="color:#204a87;font-weight:700">let</span> <span style="color:#000">recipientsArray</span> <span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#000;font-weight:700">[];</span>

  <span style="color:#204a87;font-weight:700">while</span> <span style="color:#000;font-weight:700">((</span><span style="color:#000">m</span> <span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#000">regex</span><span style="color:#000;font-weight:700">.</span><span style="color:#000">exec</span><span style="color:#000;font-weight:700">(</span><span style="color:#000">recipientString</span><span style="color:#000;font-weight:700">))</span> <span style="color:#ce5c00;font-weight:700">!==</span> <span style="color:#204a87;font-weight:700">null</span><span style="color:#000;font-weight:700">)</span> <span style="color:#000;font-weight:700">{</span>
      <span style="color:#8f5902;font-style:italic">// This is necessary to avoid infinite loops with zero-width matches
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#204a87;font-weight:700">if</span> <span style="color:#000;font-weight:700">(</span><span style="color:#000">m</span><span style="color:#000;font-weight:700">.</span><span style="color:#000">index</span> <span style="color:#ce5c00;font-weight:700">===</span> <span style="color:#000">regex</span><span style="color:#000;font-weight:700">.</span><span style="color:#000">lastIndex</span><span style="color:#000;font-weight:700">)</span> <span style="color:#000;font-weight:700">{</span>
          <span style="color:#000">regex</span><span style="color:#000;font-weight:700">.</span><span style="color:#000">lastIndex</span><span style="color:#ce5c00;font-weight:700">++</span><span style="color:#000;font-weight:700">;</span>
      <span style="color:#000;font-weight:700">}</span>
      <span style="color:#204a87;font-weight:700">let</span> <span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#204a87;font-weight:700">null</span><span style="color:#000;font-weight:700">;</span>
      <span style="color:#204a87;font-weight:700">let</span> <span style="color:#000">email</span> <span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#204a87;font-weight:700">null</span><span style="color:#000;font-weight:700">;</span>

      <span style="color:#204a87;font-weight:700">if</span> <span style="color:#000;font-weight:700">(</span><span style="color:#000">m</span><span style="color:#000;font-weight:700">[</span><span style="color:#0000cf;font-weight:700">2</span><span style="color:#000;font-weight:700">])</span> <span style="color:#000;font-weight:700">{</span>
      	<span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:700">[</span><span style="color:#0000cf;font-weight:700">2</span><span style="color:#000;font-weight:700">].</span><span style="color:#000">replace</span><span style="color:#000;font-weight:700">(</span><span style="color:#4e9a06">/,$/</span><span style="color:#000;font-weight:700">,</span> <span style="color:#4e9a06">&#39;&#39;</span><span style="color:#000;font-weight:700">).</span><span style="color:#000">replace</span><span style="color:#000;font-weight:700">(</span><span style="color:#4e9a06">/&#34;/g</span><span style="color:#000;font-weight:700">,</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:700">).</span><span style="color:#000">trim</span><span style="color:#000;font-weight:700">();</span> <span style="color:#8f5902;font-style:italic">// strip whitespaces and commas, and remove quotation marks
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000;font-weight:700">};</span>

      <span style="color:#204a87;font-weight:700">if</span> <span style="color:#000;font-weight:700">(</span><span style="color:#000">m</span><span style="color:#000;font-weight:700">[</span><span style="color:#0000cf;font-weight:700">3</span><span style="color:#000;font-weight:700">])</span> <span style="color:#000;font-weight:700">{</span>
      	<span style="color:#000">email</span> <span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:700">[</span><span style="color:#0000cf;font-weight:700">3</span><span style="color:#000;font-weight:700">].</span><span style="color:#000">replace</span><span style="color:#000;font-weight:700">(</span><span style="color:#4e9a06">/,$/</span><span style="color:#000;font-weight:700">,</span> <span style="color:#4e9a06">&#39;&#39;</span><span style="color:#000;font-weight:700">).</span><span style="color:#000">trim</span><span style="color:#000;font-weight:700">();</span> <span style="color:#8f5902;font-style:italic">// strip whitespaces and commas from end of string
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000;font-weight:700">}</span>

      <span style="color:#204a87;font-weight:700">let</span> <span style="color:#000">item</span> <span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#000;font-weight:700">{</span>
      	<span style="color:#000">name</span><span style="color:#ce5c00;font-weight:700">:</span> <span style="color:#000">name</span><span style="color:#000;font-weight:700">,</span>
      	<span style="color:#000">email</span><span style="color:#ce5c00;font-weight:700">:</span> <span style="color:#000">email</span><span style="color:#000;font-weight:700">,</span>
      <span style="color:#000;font-weight:700">};</span>
      <span style="color:#000">recipientsArray</span><span style="color:#000;font-weight:700">.</span><span style="color:#000">push</span><span style="color:#000;font-weight:700">(</span><span style="color:#000">item</span><span style="color:#000;font-weight:700">)</span>
  <span style="color:#000;font-weight:700">}</span>
  <span style="color:#204a87;font-weight:700">return</span> <span style="color:#000">recipientsArray</span><span style="color:#000;font-weight:700">;</span>
<span style="color:#000;font-weight:700">}</span>
</code></pre></div><p>The main part of the function is in this regex <code>(([\w,\&quot;\s]+)\s)?&lt;?([^@&lt;\s]+@[^@\s&gt;]+)&gt;?,</code>, which can be broken down into three main parts:</p><ol><li><code>(([\w,\&quot;\s]+)\s)?</code></li><li><code>&lt;?([^@&lt;\s]+@[^@\s&gt;]+)&gt;?</code></li><li><code>,</code></li></ol><p>The <strong>first part</strong> <code>(([\w,\&quot;\s]+)\s)?</code> optionally identifies the name. The outermost round brackets denote a group. Inside it, we have a square bracket that tells it to look for any of these characters in the list: <code>\w</code> (any word character, that is, any letter, digit, or understore, equivalent to <code>[a-zA-Z0-9_]</code>), <code>,</code>, <code>&quot;</code>, and <code>\s</code> (a whitespace character). The <code>+</code> tells regex to match as many of these as possible, that is, it can match any character that belongs in the list any number of times. This is followed by a space again. The question mark that follows tells it that this whole group is optional - there may be some items without names appearing in front.</p><p>The <strong>second part</strong> <code>&lt;?([^@&lt;\s]+@[^@\s&gt;]+)&gt;?</code> identifies the email. The opening and closing angle brackets are optional, therefore they are both followed by a question mark. The expression enclosed in round brackets describes the email format, which basically says look for a bunch of adjacent characters that are not <code>@</code> or <code>\s</code>, followed by a <code>@</code> symbol, then followed by another bunch of characters that are not <code>@</code> or <code>\s</code>. This is then enclosed by optional angle brackets.</p><p>The <strong>last comma</strong> specifies the separator. Note that I don't think the last entry ends with a trailing comma, and this which would cause the regex to skip the last recipient when parsing. However this problem can be easily circumvented by manually adding a comma to the end of the string before using the regex.</p><p><code>regex.exec</code> then returns the groups that were identifies through the round brackets. After that, all that's left to do is to trim some residual spaces and commas from the end of the string and remove the quotation marks that sometimes encloses a name.</p></div><hr class="gap-top"><div class="faded gap-top message">You can email me at lingyihuu(at)gmail.com if you have any comments, suggestions, or questions. I should respond promptly, because frankly I am not famous enough to be ignoring emails yet.</div><div class="faded gap-top"><a href="https://theconfused.me/" style="margin-right:2rem">&larr; home</a> <a href="https://theconfused.me/blog">&larr; blog archive</a></div></div></div></body></html>