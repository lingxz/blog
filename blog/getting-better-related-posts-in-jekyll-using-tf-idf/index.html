<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta content="text/html; charset=utf-8" http-equiv="content-type"><title>Getting better related posts in Jekyll using tf-idf - theconfused.me</title><meta content="Getting better related posts in Jekyll using tf-idf - theconfused.me" property="title"><meta content="Getting better related posts in Jekyll using tf-idf - theconfused.me" property="og:title"><meta property="og:description" content="UPDATE: In my latest revamp of my blog, I did away with related posts altogether. I&#39;m now using Hugo for static site generation instead of Jekyll. I also decided to conscientiously tag every post anyway since it didn&#39;t take too much effort (wow, exceeding my own expectations), so much of this is useless to me now.
It&#39;s no secret that Jekyll&#39;s built in related posts functionality doesn&#39;t return related posts--it only gives you the most recent posts."><meta property="og:type" content="article"><meta property="og:url" content="https://theconfused.me/blog/getting-better-related-posts-in-jekyll-using-tf-idf/"><meta property="article:published_time" content="2017-08-26T00:00:00&#43;00:00"><meta name="generator" content="Hugo 0.40.1"><style type="text/css">:root{--main-color:#4c4e4f;--secondary-color:cornflowerblue;--logo-text-color:#fff;--heading-text-color:#4c4e4f;--body-text-color:#4c4e4f;--background-color:#fdfdff}body,html{color:#303030;font-family:Helvetica,Arial,sans-serif;font-size:15px;letter-spacing:.02em}#toc,.post-content{line-height:1.5}h1,h2{font-size:1.5rem}h3,strong{font-size:1rem}h1:focus,h2:focus,h3:focus,h4:focus{outline:0}.main{max-width:650px;margin:0 auto;padding:1rem}.container{position:relative}.logo{font-size:1.5rem;font-weight:600;color:var(--secondary-color)}a{color:inherit;text-decoration:none;transition:.1s color linear,.1s border-color linear}a:hover:not(.logo){color:var(--secondary-color)}.article a{border-bottom:1px solid rgba(48,48,48,.4)}.article a:hover{border-bottom-color:var(--secondary-color)}hr{border:0;border-top:1px dashed rgba(48,48,48,.18)}.gap-top{margin-top:1.65rem}.posts-list{display:flex;margin-top:1rem}.posts-list strong{margin-left:.66rem}.date{min-width:60px;text-align:right}.faded{color:rgba(48,48,48,.4);font-style:italic;font-weight:700}pre{font-size:.9em;padding:10px 20px 10px 20px;overflow:auto;line-height:1.25em}p code{font-weight:700}.message{font-weight:400}@media only screen and (min-width:875px){.main{padding:3rem 1rem;padding:bottom: 5rem}}figure{margin:2em 1em}img{display:block;margin-left:auto;margin-right:auto;box-shadow:1px 1px 2px 2px #bbb;max-width:100%}figure.no-border img{box-shadow:none}figure.img-wide img{margin-left:-100px;margin-right:-100px;max-width:850px}@media (max-width:850px){figure.img-wide img{margin-left:0;margin-right:0;max-width:100%}}figcaption{text-align:center;margin-top:.5em;color:gray}blockquote{border-left-style:solid;border-left-width:1px;border-color:rgba(48,48,48,.18);border-width:.25rem;margin-left:0;margin-top:0;margin-right:0;padding-left:1rem}blockquote p{color:#666;margin-top:0;font-style:italic}blockquote p>cite{text-transform:uppercase;font-style:normal;letter-spacing:.1em;font-size:.875rem;display:block}table{font-size:14px;border-collapse:collapse;margin:2rem auto;padding:0}table tr{border-top:1px solid #ccc;margin:0;padding:0}table tr td[align=center],table tr th[align=center]{text-align:center}table tr td,table tr th{border:1px solid #ccc;text-align:left;margin:0;padding:6px 13px}#toc{position:fixed}#toc>.toc-list{max-width:250px;overflow:hidden;position:fixed;right:2rem}@media (min-width:1200px){#toc>.toc-list{display:block;top:100px}}@media (min-width:1330px){#toc>.toc-list{max-width:300px;right:3rem}}#toc ol{list-style:none}.gray{color:rgba(48,48,48,.4);font-weight:700}</style><link rel="icon" href="https://theconfused.me/favicon.ico" type="image/x-icon"><link href="https://theconfused.me/feed.xml" rel="alternate" type="application/atom+xml" title="theconfused.me"><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-96137027-1","auto"),ga("send","pageview")</script><script async src="//www.google-analytics.com/analytics.js"></script></head><body><div class="main"><div class="container" class="article gap-top-container"><div style="margin-bottom:1.5rem"><a class="logo" href="https://theconfused.me/">theconfused.me</a></div><span class="gray">26 Aug 2017 { <a href="https://theconfused.me/tags/jekyll">jekyll</a> <a href="https://theconfused.me/tags/python">python</a> }</span><h1>Getting better related posts in Jekyll using tf-idf</h1><div class="post-content article"><p><strong>UPDATE:</strong> In my latest revamp of my blog, I did away with related posts altogether. I'm now using Hugo for static site generation instead of Jekyll. I also decided to conscientiously tag every post anyway since it didn't take too much effort (wow, exceeding my own expectations), so much of this is useless to me now.</p><hr><p>It's no secret that Jekyll's built in related posts functionality doesn't return related posts--it only gives you the most recent posts. So I looked around for better solutions.</p><p>One <a href="https://github.com/jumanji27/related-posts-jekyll-plugin" target="_blank">popular solution</a> is to calculate related posts based on a post's tags. However, this requires one to conscientiously tag every post accurately, which seems unlikely. I wanted a much lazier solution--to calculate how related two posts are only based on their content.</p><h2 id="calculating-document-correlation">Calculating document correlation</h2><p>The aim is simple: to have some way of calculating similarity score between two posts, then we can rank and take the top 5 posts as the related posts.</p><p>The common way of measuring document similarity is by transforming the set of documents into a <a href="https://en.wikipedia.org/wiki/Tfâ€“idf" target="_blank">tf-idf</a> matrix, then computing the <a href="https://en.wikipedia.org/wiki/Cosine_similarity" target="_blank">cosine similarity</a> to get the similarity score of each document with all other documents. Tf-idf stands for term frequency-inverse document frequency, and it is composed of two parts:</p><ul><li><strong>term frequency</strong>: proportional to how often a word appears in a document. This accords importance to words that appear frequently in a document.</li><li><strong>inverse document frequency</strong>: indicates how often a word appears in all documents. If it appears many times in all documents, then it is given less importance. These are the words that are going to appear frequently no matter what the post is truly about.</li></ul><p>The tf-idf matrix is a matrix where each column represents a document and each row represents a word, and each cell represents the tf-idf value of the word within the document. <a href="http://www.tfidf.com/" target="_blank">Other people</a> have explained this better than me.</p><p>But before doing this, some tokenization and stemming is needed, since I wouldn't want words like &quot;taken&quot; and &quot;taking&quot; to be identified as two separate words. I also want to remove stop words, which are commonly-used words like &quot;the&quot;, &quot;a&quot;, &quot;of&quot;.</p><h2 id="the-code">The code</h2><p>Optimally, I would use Ruby to do this since Jekyll is based on Ruby, but unfortunately my Ruby knowledge is zero and I decided to use Python for this. For people who just want to see code, the scripts can be found on my <a href="https://github.com/lingxz/lingxz.github.io/tree/0827ae2b850c3ba7288d099ea41e41becfa138e5/scripts" target="_blank">GitHub repo</a>.</p><p>First I wrote a function that processes the markdown files containing the posts:</p><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#204a87;font-weight:700">import</span> <span style="color:#000">frontmatter</span>
<span style="color:#204a87;font-weight:700">import</span> <span style="color:#000">glob</span>

<span style="color:#204a87;font-weight:700">def</span> <span style="color:#000">get_posts</span><span style="color:#000;font-weight:700">(</span><span style="color:#000">folder</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#39;./_posts&#39;</span><span style="color:#000;font-weight:700">):</span>
    <span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#000;font-weight:700">{}</span>
    <span style="color:#204a87;font-weight:700">for</span> <span style="color:#000">filepath</span> <span style="color:#204a87;font-weight:700">in</span> <span style="color:#000">glob</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">glob</span><span style="color:#000;font-weight:700">(</span><span style="color:#000">folder</span> <span style="color:#ce5c00;font-weight:700">+</span> <span style="color:#4e9a06">&#34;/*&#34;</span><span style="color:#000;font-weight:700">):</span>
        <span style="color:#000">filename</span> <span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#000">filepath</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">split</span><span style="color:#000;font-weight:700">(</span><span style="color:#4e9a06">&#39;</span><span style="color:#4e9a06">\\</span><span style="color:#4e9a06">&#39;</span><span style="color:#000;font-weight:700">)[</span><span style="color:#ce5c00;font-weight:700">-</span><span style="color:#0000cf;font-weight:700">1</span><span style="color:#000;font-weight:700">]</span>
        <span style="color:#000">slug</span> <span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#000">filename</span><span style="color:#000;font-weight:700">[</span><span style="color:#0000cf;font-weight:700">11</span><span style="color:#000;font-weight:700">:</span><span style="color:#ce5c00;font-weight:700">-</span><span style="color:#0000cf;font-weight:700">3</span><span style="color:#000;font-weight:700">]</span>
        <span style="color:#000">post</span> <span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#000">frontmatter</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">load</span><span style="color:#000;font-weight:700">(</span><span style="color:#000">filepath</span><span style="color:#000;font-weight:700">)</span>
        <span style="color:#204a87;font-weight:700">if</span> <span style="color:#4e9a06">&#34;slug&#34;</span> <span style="color:#204a87;font-weight:700">in</span> <span style="color:#000">post</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">keys</span><span style="color:#000;font-weight:700">():</span>
            <span style="color:#000">slug</span> <span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#000">post</span><span style="color:#000;font-weight:700">[</span><span style="color:#4e9a06">&#34;slug&#34;</span><span style="color:#000;font-weight:700">]</span>
        <span style="color:#000">result</span><span style="color:#000;font-weight:700">[</span><span style="color:#000">slug</span><span style="color:#000;font-weight:700">]</span> <span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#000">post</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">content</span>
    <span style="color:#204a87;font-weight:700">return</span> <span style="color:#000">result</span></code></pre></div><p>This just gets all the files from the <code>_posts/</code> folder, gets the post slug and content, and stores the information in a dictionary. I used the <code>python-frontmatter</code> module to deal with the yaml frontmatter.</p><p>Then I use the <code>nltk</code> and <code>scikit-learn</code> libraries to do the text processing. <code>nltk</code> has the capabilities to do all the natural language processing shenanigans I need while <code>scikit-learn</code> has the <code>TfidVectorizer</code> to turn documents into a tf-idf vector.</p><p>First, some standard stemming and tokenizing (where <code>nltk</code> does most of the work):</p><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#204a87;font-weight:700">import</span> <span style="color:#000">nltk</span>
<span style="color:#204a87;font-weight:700">import</span> <span style="color:#000">string</span>
<span style="color:#204a87;font-weight:700">from</span> <span style="color:#000">sklearn.feature_extraction.text</span> <span style="color:#204a87;font-weight:700">import</span> <span style="color:#000">TfidfVectorizer</span>

<span style="color:#000">stemmer</span> <span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#000">nltk</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">stem</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">porter</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">PorterStemmer</span><span style="color:#000;font-weight:700">()</span>
<span style="color:#000">nltk</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">download</span><span style="color:#000;font-weight:700">(</span><span style="color:#4e9a06">&#39;punkt&#39;</span><span style="color:#000;font-weight:700">)</span>  <span style="color:#8f5902;font-style:italic"># download the needed data for tokenizing</span>

<span style="color:#204a87;font-weight:700">def</span> <span style="color:#000">stem_tokens</span><span style="color:#000;font-weight:700">(</span><span style="color:#000">tokens</span><span style="color:#000;font-weight:700">,</span> <span style="color:#000">stemmer</span><span style="color:#000;font-weight:700">):</span>
    <span style="color:#000">stemmed</span> <span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#000;font-weight:700">[]</span>
    <span style="color:#204a87;font-weight:700">for</span> <span style="color:#000">item</span> <span style="color:#204a87;font-weight:700">in</span> <span style="color:#000">tokens</span><span style="color:#000;font-weight:700">:</span>
        <span style="color:#000">stemmed</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">append</span><span style="color:#000;font-weight:700">(</span><span style="color:#000">stemmer</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">stem</span><span style="color:#000;font-weight:700">(</span><span style="color:#000">item</span><span style="color:#000;font-weight:700">))</span>
    <span style="color:#204a87;font-weight:700">return</span> <span style="color:#000">stemmed</span>

<span style="color:#204a87;font-weight:700">def</span> <span style="color:#000">tokenize</span><span style="color:#000;font-weight:700">(</span><span style="color:#000">text</span><span style="color:#000;font-weight:700">):</span>
    <span style="color:#000">tokens</span> <span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#000">nltk</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">word_tokenize</span><span style="color:#000;font-weight:700">(</span><span style="color:#000">text</span><span style="color:#000;font-weight:700">)</span>
    <span style="color:#000">stems</span> <span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#000">stem_tokens</span><span style="color:#000;font-weight:700">(</span><span style="color:#000">tokens</span><span style="color:#000;font-weight:700">,</span> <span style="color:#000">stemmer</span><span style="color:#000;font-weight:700">)</span>
    <span style="color:#204a87;font-weight:700">return</span> <span style="color:#000">stems</span> </code></pre></div><p>Then I create the vectorizer with the <code>tokenize</code> function, and clean the data by lowercasing everything and removing punctuation, and put the data into the vectorizer.</p><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">vectorizer</span> <span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#000">TfidfVectorizer</span><span style="color:#000;font-weight:700">(</span><span style="color:#000">tokenizer</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#000">tokenize</span><span style="color:#000;font-weight:700">,</span> <span style="color:#000">stop_words</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#39;english&#39;</span><span style="color:#000;font-weight:700">)</span>
<span style="color:#000">posts</span> <span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#000">get_posts</span><span style="color:#000;font-weight:700">()</span>

<span style="color:#8f5902;font-style:italic"># lowercase and remove punctuation from post data</span>
<span style="color:#000">cleaned_posts</span> <span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#000;font-weight:700">{</span><span style="color:#000">slug</span><span style="color:#000;font-weight:700">:</span> <span style="color:#000">post</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">lower</span><span style="color:#000;font-weight:700">()</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">translate</span><span style="color:#000;font-weight:700">(</span><span style="color:#204a87">str</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">maketrans</span><span style="color:#000;font-weight:700">(</span><span style="color:#4e9a06">&#39;&#39;</span><span style="color:#000;font-weight:700">,</span> <span style="color:#4e9a06">&#39;&#39;</span><span style="color:#000;font-weight:700">,</span> <span style="color:#000">string</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">punctuation</span><span style="color:#000;font-weight:700">))</span> <span style="color:#204a87;font-weight:700">for</span> <span style="color:#000">slug</span><span style="color:#000;font-weight:700">,</span> <span style="color:#000">post</span> <span style="color:#204a87;font-weight:700">in</span> <span style="color:#000">posts</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">items</span><span style="color:#000;font-weight:700">()}</span>
<span style="color:#000">slugs</span> <span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#204a87">list</span><span style="color:#000;font-weight:700">(</span><span style="color:#000">cleaned_posts</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">keys</span><span style="color:#000;font-weight:700">())</span>

<span style="color:#000">tfidf</span> <span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#000">vectorizer</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">fit_transform</span><span style="color:#000;font-weight:700">(</span><span style="color:#204a87">list</span><span style="color:#000;font-weight:700">(</span><span style="color:#000">cleaned_posts</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">values</span><span style="color:#000;font-weight:700">()))</span>
<span style="color:#000">matrix</span> <span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#000;font-weight:700">(</span><span style="color:#000">tfidf</span> <span style="color:#ce5c00;font-weight:700">*</span> <span style="color:#000">tfidf</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">T</span><span style="color:#000;font-weight:700">)</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">A</span>  <span style="color:#8f5902;font-style:italic"># calculate cosine similarity</span>

<span style="color:#8f5902;font-style:italic"># example matrix:</span>
<span style="color:#8f5902;font-style:italic"># [[ 1.          0.12274921  0.08471414  0.0465803   0.04871383  0.00808005</span>
<span style="color:#8f5902;font-style:italic">#   0.0196523 ]</span>
<span style="color:#8f5902;font-style:italic"># [ 0.12274921  1.          0.10744334  0.20886152  0.07531169  0.0452097</span>
<span style="color:#8f5902;font-style:italic">#   0.04654832]</span>
<span style="color:#8f5902;font-style:italic"># [ 0.08471414  0.10744334  1.          0.05036088  0.0453141   0.02618316</span>
<span style="color:#8f5902;font-style:italic">#   0.04787127]</span>
<span style="color:#8f5902;font-style:italic"># [ 0.0465803   0.20886152  0.05036088  1.          0.16894053  0.03408972</span>
<span style="color:#8f5902;font-style:italic">#   0.03633891]</span>
<span style="color:#8f5902;font-style:italic"># [ 0.04871383  0.07531169  0.0453141   0.16894053  1.          0.03106121</span>
<span style="color:#8f5902;font-style:italic">#   0.03287819]</span>
<span style="color:#8f5902;font-style:italic"># [ 0.00808005  0.0452097   0.02618316  0.03408972  0.03106121  1.</span>
<span style="color:#8f5902;font-style:italic">#   0.02760873]</span>
<span style="color:#8f5902;font-style:italic"># [ 0.0196523   0.04654832  0.04787127  0.03633891  0.03287819  0.02760873</span>
<span style="color:#8f5902;font-style:italic">#   1.        ]]</span></code></pre></div><p>The last calculation returns a symmetric matrix $M$ where the $M_{ij}$ is the similarity between document $i$ and document $j$. As a check, we can see that the elements on the diagonal are unity since a document's similarity with itself should be 1.</p><p>Then we just need to sort through the matrix to get the top $n$ most related posts. In this case, I took $n = 3$.</p><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">num_best</span> <span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#0000cf;font-weight:700">3</span>
<span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#000;font-weight:700">{}</span>
<span style="color:#204a87;font-weight:700">for</span> <span style="color:#000">i</span><span style="color:#000;font-weight:700">,</span> <span style="color:#000">row</span> <span style="color:#204a87;font-weight:700">in</span> <span style="color:#204a87">enumerate</span><span style="color:#000;font-weight:700">(</span><span style="color:#000">matrix</span><span style="color:#000;font-weight:700">):</span>
    <span style="color:#000">indices</span> <span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#000">row</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">argsort</span><span style="color:#000;font-weight:700">()[</span><span style="color:#ce5c00;font-weight:700">-</span><span style="color:#000">num_best</span><span style="color:#ce5c00;font-weight:700">-</span><span style="color:#0000cf;font-weight:700">1</span><span style="color:#000;font-weight:700">:</span><span style="color:#ce5c00;font-weight:700">-</span><span style="color:#0000cf;font-weight:700">1</span><span style="color:#000;font-weight:700">][::</span><span style="color:#ce5c00;font-weight:700">-</span><span style="color:#0000cf;font-weight:700">1</span><span style="color:#000;font-weight:700">]</span>
    <span style="color:#000">current_slug</span> <span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#000">slugs</span><span style="color:#000;font-weight:700">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:700">]</span>
    <span style="color:#000">result</span><span style="color:#000;font-weight:700">[</span><span style="color:#000">current_slug</span><span style="color:#000;font-weight:700">]</span> <span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#000;font-weight:700">[</span><span style="color:#000">slugs</span><span style="color:#000;font-weight:700">[</span><span style="color:#000">index</span><span style="color:#000;font-weight:700">]</span> <span style="color:#204a87;font-weight:700">for</span> <span style="color:#000">index</span> <span style="color:#204a87;font-weight:700">in</span> <span style="color:#000">indices</span><span style="color:#000;font-weight:700">]</span>
<span style="color:#8f5902;font-style:italic"># related posts are now stored in the result variable</span></code></pre></div><h2 id="putting-it-back-into-jekyll">Putting it back into Jekyll</h2><p>Now, we have to find some way of inserting this result back into Jekyll. To do this, I decided to make use of <a href="https://jekyllrb.com/docs/datafiles/" target="_blank">data files</a> to be accessed by my layouts:</p><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#204a87;font-weight:700">def</span> <span style="color:#000">write_result_to_file</span><span style="color:#000;font-weight:700">(</span><span style="color:#000">related</span><span style="color:#000;font-weight:700">,</span> <span style="color:#204a87">file</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#39;./_data/related.yml&#39;</span><span style="color:#000;font-weight:700">):</span>
    <span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#000;font-weight:700">[]</span>
    <span style="color:#204a87;font-weight:700">for</span> <span style="color:#000">r</span> <span style="color:#204a87;font-weight:700">in</span> <span style="color:#000">related</span><span style="color:#000;font-weight:700">:</span>
        <span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#000;font-weight:700">{</span>
            <span style="color:#4e9a06">&#39;post&#39;</span><span style="color:#000;font-weight:700">:</span> <span style="color:#000">r</span><span style="color:#000;font-weight:700">,</span>
            <span style="color:#4e9a06">&#39;related&#39;</span><span style="color:#000;font-weight:700">:</span> <span style="color:#000">related</span><span style="color:#000;font-weight:700">[</span><span style="color:#000">r</span><span style="color:#000;font-weight:700">]</span>
        <span style="color:#000;font-weight:700">}</span>
        <span style="color:#000">data</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">append</span><span style="color:#000;font-weight:700">(</span><span style="color:#000">r</span><span style="color:#000;font-weight:700">)</span>
    <span style="color:#204a87;font-weight:700">with</span> <span style="color:#204a87">open</span><span style="color:#000;font-weight:700">(</span><span style="color:#204a87">file</span><span style="color:#000;font-weight:700">,</span> <span style="color:#4e9a06">&#39;w&#39;</span><span style="color:#000;font-weight:700">)</span> <span style="color:#204a87;font-weight:700">as</span> <span style="color:#000">f</span><span style="color:#000;font-weight:700">:</span>
        <span style="color:#000">yaml</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">dump</span><span style="color:#000;font-weight:700">(</span><span style="color:#000">data</span><span style="color:#000;font-weight:700">,</span> <span style="color:#000">f</span><span style="color:#000;font-weight:700">,</span> <span style="color:#000">default_flow_style</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#3465a4">False</span><span style="color:#000;font-weight:700">)</span>

<span style="color:#8f5902;font-style:italic"># then we just have to put the previously calculated result into this function</span>
<span style="color:#000">write_result_to_file</span><span style="color:#000;font-weight:700">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:700">)</span></code></pre></div><p>This function does some processing with the dictionary it receives and dumps it into <code>_data/related.yml</code>. The resulting file should look something like this:</p><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">-<span style="color:#f8f8f8"> </span>post<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8"> </span>setting-up-jekyll<span style="color:#f8f8f8">
</span><span style="color:#f8f8f8">  </span>related<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8">
</span><span style="color:#f8f8f8">  </span>-<span style="color:#f8f8f8"> </span>drifter-writing-interactive-fiction-with-ink<span style="color:#f8f8f8">
</span><span style="color:#f8f8f8">  </span>-<span style="color:#f8f8f8"> </span>getting-better-related-posts-in-jekyll-using-tf-idf<span style="color:#f8f8f8">
</span><span style="color:#f8f8f8">  </span>-<span style="color:#f8f8f8"> </span>git-for-noobs<span style="color:#f8f8f8">
</span><span style="color:#f8f8f8"></span>-<span style="color:#f8f8f8"> </span>post<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8"> </span>drifter-writing-interactive-fiction-with-ink<span style="color:#f8f8f8">
</span><span style="color:#f8f8f8">  </span>related<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8">
</span><span style="color:#f8f8f8">  </span>-<span style="color:#f8f8f8"> </span>solving-the-<span style="color:#0000cf;font-weight:700">24</span>-game<span style="color:#f8f8f8">
</span><span style="color:#f8f8f8">  </span>-<span style="color:#f8f8f8"> </span>setting-up-jekyll<span style="color:#f8f8f8">
</span><span style="color:#f8f8f8">  </span>-<span style="color:#f8f8f8"> </span>git-for-noobs</code></pre></div><p>Inserting this data into my <code>post</code> layout was more difficult than I thought, because I could find no way of getting the post object from the post slug. So, I ended up with this ugly code in my <code>_layouts/post.html</code>:</p><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-liquid" data-lang="liquid">{% for item in site.data.related %}
  {% if page.slug == item.post %}
    &lt;nav class=&#34;read-next&#34;&gt;
      &lt;h3 class=&#34;read-next-label&#34;&gt;Other posts you might enjoy&lt;/h3&gt;
      &lt;ul&gt;
        {% for pslug in item.related %}
          {% for p in site.posts %}
            {% if p.slug == pslug %}
            &lt;li&gt;&lt;a class=&#34;read-next-title&#34; href=&#34;{{ p.url | prepend: site.baseurl }}&#34; title=&#34;{{ p.title | xml_escape }}&#34;&gt;{{ p.title | xml_escape }}&lt;/a&gt;&lt;/li&gt;
            {% endif %}
          {% endfor %}
        {% endfor %}
      &lt;/ul&gt;
    &lt;/nav&gt;
  {% endif %}
{% endfor %}</code></pre></div><p>Ew, 3 nested for loops. But I couldn't find a way out of it--the first loop is to find the relevant element in the list that the post corresponds to, by checking the slugs. The second to loop through the slugs, so that I can render them, however, to get the post object from the slug, the third loop is needed to loop through all the posts to see which post has a slug that matches.</p><p>Fortunately, this is only run when building the site, and doesn't slow down things on the client side. I only have a handful of posts on my blog, so it really makes no difference. The inconvenience it may bring to some people is that you would have to do the extra step of running the python file to generate <code>_data/related.yml</code> before building the site. But I use <a href="https://gulpjs.com/" target="_blank">gulp</a> to build my site, so I just had to add an extra line in my <a href="https://github.com/lingxz/lingxz.github.io/blob/0827ae2b850c3ba7288d099ea41e41becfa138e5/gulpfile.js" target="_blank">gulpfile</a>:</p><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#000">shell</span><span style="color:#000;font-weight:700">.</span><span style="color:#000">exec</span><span style="color:#000;font-weight:700">(</span><span style="color:#4e9a06">&#39;python scripts/similarity.py&#39;</span><span style="color:#000;font-weight:700">)</span>
</code></pre></div></div><hr class="gap-top"><div class="faded gap-top message">You can email me at lingyihuu(at)gmail.com if you have any comments, suggestions, or questions. I should respond promptly, because frankly I am not famous enough to be ignoring emails yet.</div><div class="faded gap-top"><a href="https://theconfused.me/" style="margin-right:2rem">&larr; home</a> <a href="https://theconfused.me/blog">&larr; blog archive</a></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.6.0/katex.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/contrib/auto-render.min.js" integrity="sha384-dq1/gEHSxPZQ7DdrM82ID4YVol9BYyU7GbWlIwnwyPzotpoc57wDw/guX8EaYGPx" crossorigin="anonymous"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.6.0/katex.min.css"><script>renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]});for(var inlineMathArray=document.querySelectorAll("script[type='math/tex']"),i=0;i<inlineMathArray.length;i++){var inlineMath=inlineMathArray[i],tex=inlineMath.innerText||inlineMath.textContent;(replaced=document.createElement("span")).innerHTML=katex.renderToString(tex,{displayMode:!1}),inlineMath.parentNode.replaceChild(replaced,inlineMath)}var displayMathArray=document.querySelectorAll("script[type='math/tex; mode=display']");for(i=0;i<displayMathArray.length;i++){var replaced,displayMath=displayMathArray[i];tex=displayMath.innerHTML;(replaced=document.createElement("span")).innerHTML=katex.renderToString(tex.replace(/%.*/g,""),{displayMode:!0}),displayMath.parentNode.replaceChild(replaced,displayMath)}</script></body></html>