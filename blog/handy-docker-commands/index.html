<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta content="text/html; charset=utf-8" http-equiv="content-type"><title>A few handy docker commands to setting up a server with Nginx and Let&#39;s Encrypt - theconfused.me</title><meta content="A few handy docker commands to setting up a server with Nginx and Let&#39;s Encrypt - theconfused.me" property="title"><meta content="A few handy docker commands to setting up a server with Nginx and Let&#39;s Encrypt - theconfused.me" property="og:title"><meta property="og:description" content="Recently I set up my server on DigitalOcean with Docker and Nginx as a reverse proxy. This is a brief description of how I did it and a few Docker commands I found most useful.
"><meta property="og:type" content="article"><meta property="og:url" content="https://theconfused.me/blog/handy-docker-commands/"><meta property="article:published_time" content="2017-08-19T00:00:00&#43;00:00"><meta name="generator" content="Hugo 0.40.1"><style type="text/css">:root{--main-color:#4c4e4f;--secondary-color:cornflowerblue;--logo-text-color:#fff;--heading-text-color:#4c4e4f;--body-text-color:#4c4e4f;--background-color:#fdfdff}body,html{color:#303030;font-family:Helvetica,Arial,sans-serif;font-size:15px;letter-spacing:.02em}#toc,.post-content{line-height:1.5}h1,h2{font-size:1.5rem}h3,strong{font-size:1rem}h1:focus,h2:focus,h3:focus,h4:focus{outline:0}.main{max-width:650px;margin:0 auto;padding:1rem}.container{position:relative}.logo{font-size:1.5rem;font-weight:600;color:var(--secondary-color)}a{color:inherit;text-decoration:none;transition:.1s color linear,.1s border-color linear}a:hover:not(.logo){color:var(--secondary-color)}.article a{border-bottom:1px solid rgba(48,48,48,.4)}.article a:hover{border-bottom-color:var(--secondary-color)}hr{border:0;border-top:1px dashed rgba(48,48,48,.18)}.gap-top{margin-top:1.65rem}.posts-list{display:flex;margin-top:1rem}.posts-list strong{margin-left:.66rem}.date{min-width:60px;text-align:right}.faded{color:rgba(48,48,48,.4);font-style:italic;font-weight:700}pre{font-size:.9em;padding:10px 20px 10px 20px;overflow:auto;line-height:1.25em}p code{font-weight:700}.message{font-weight:400}@media only screen and (min-width:875px){.main{padding:3rem 1rem;padding:bottom: 5rem}}figure{margin:2em 1em}img{display:block;margin-left:auto;margin-right:auto;box-shadow:1px 1px 2px 2px #bbb;max-width:100%}figure.no-border img{box-shadow:none}figure.img-wide img{margin-left:-100px;margin-right:-100px;max-width:850px}@media (max-width:850px){figure.img-wide img{margin-left:0;margin-right:0;max-width:100%}}figcaption{text-align:center;margin-top:.5em;color:gray}blockquote{border-left-style:solid;border-left-width:1px;border-color:rgba(48,48,48,.18);border-width:.25rem;margin-left:0;margin-top:0;margin-right:0;padding-left:1rem}blockquote p{color:#666;margin-top:0;font-style:italic}blockquote p>cite{text-transform:uppercase;font-style:normal;letter-spacing:.1em;font-size:.875rem;display:block}table{font-size:14px;border-collapse:collapse;margin:2rem auto;padding:0}table tr{border-top:1px solid #ccc;margin:0;padding:0}table tr td[align=center],table tr th[align=center]{text-align:center}table tr td,table tr th{border:1px solid #ccc;text-align:left;margin:0;padding:6px 13px}#toc{position:fixed}#toc>.toc-list{max-width:250px;overflow:hidden;position:fixed;right:2rem}@media (min-width:1200px){#toc>.toc-list{display:block;top:100px}}@media (min-width:1330px){#toc>.toc-list{max-width:300px;right:3rem}}#toc ol{list-style:none}.gray{color:rgba(48,48,48,.4);font-weight:700}</style><link rel="icon" href="https://theconfused.me/favicon.ico" type="image/x-icon"><link href="https://theconfused.me/feed.xml" rel="alternate" type="application/atom+xml" title="theconfused.me"><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-96137027-1","auto"),ga("send","pageview")</script><script async src="//www.google-analytics.com/analytics.js"></script></head><body><div class="main"><div class="container" class="article gap-top-container"><div style="margin-bottom:1.5rem"><a class="logo" href="https://theconfused.me/">theconfused.me</a></div><span class="gray">19 Aug 2017 { <a href="https://theconfused.me/tags/docker">docker</a> <a href="https://theconfused.me/tags/nginx">nginx</a> }</span><h1>A few handy docker commands to setting up a server with Nginx and Let&#39;s Encrypt</h1><div class="post-content article"><p>Recently I set up my server on DigitalOcean with Docker and Nginx as a reverse proxy. This is a brief description of how I did it and a few Docker commands I found most useful.</p><h2 id="setting-up-a-server">Setting up a server</h2><p>This is roughly similar to <a href="https://cloud.google.com/community/tutorials/nginx-reverse-proxy-docker" target="_blank">this article on Google Cloud</a>, just a stripped and slightly reorganized version.</p><h3 id="creating-certs-directory">Creating certs directory</h3><p>To enable HTTPS, we need certificates. So first we need to create a directory to hold the certs.</p><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#204a87">cd</span>
mkdir certs</code></pre></div><p>We use the <a href="https://github.com/JrCs/docker-letsencrypt-nginx-proxy-companion" target="_blank">Docker Let's Encrypt nginx-proxy companion</a> to automatically issue and use signed certificates. To do this, we declare volumes when running the reverse-proxy so the <code>nginx-letsencrypt</code> companion can populate them with certificates.</p><p>However, in order for <code>nginx-proxy</code> to proxy other containers, they have to be on the same Docker network.</p><h3 id="running-all-the-containers">Running all the containers</h3><p>So we first create a network:</p><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">docker network create --driver bridge reverse-proxy</code></pre></div><p>And we run the nginx reverse proxy and the letsencrypt companion on this network, using the <code>--net reverse-proxy</code> command.</p><p>Running the nginx reverse proxy:</p><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">docker run -d -p <span style="color:#0000cf;font-weight:700">80</span>:80 -p <span style="color:#0000cf;font-weight:700">443</span>:443 --name nginx-proxy --net reverse-proxy -v <span style="color:#000">$HOME</span>/certs:/etc/nginx/certs:ro -v /etc/nginx/vhost.d -v /usr/share/nginx/html -v /var/run/docker.sock:/tmp/docker.sock:ro --label com.github.jrcs.letsencrypt_nginx_proxy_companion.nginx_proxy<span style="color:#ce5c00;font-weight:700">=</span><span style="color:#204a87">true</span> jwilder/nginx-proxy</code></pre></div><p>Running the <code>nginx-letsencrypt</code> companion:</p><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">docker run -d --name nginx-letsencrypt --net reverse-proxy --volumes-from nginx-proxy -v <span style="color:#000">$HOME</span>/certs:/etc/nginx/certs:rw -v /var/run/docker.sock:/var/run/docker.sock:ro jrcs/letsencrypt-nginx-proxy-companion</code></pre></div><h3 id="docker-compose">docker-compose</h3><p>We can then start all our website or other app containers using a <code>docker-compose.yml</code> file. For example, my docker-compose file looks something like this:</p><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">version<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8"> </span><span style="color:#4e9a06">&#39;2&#39;</span><span style="color:#f8f8f8">
</span><span style="color:#f8f8f8"></span>services<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8">
</span><span style="color:#f8f8f8">  </span>blog<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8">
</span><span style="color:#f8f8f8">    </span>restart<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8"> </span>always<span style="color:#f8f8f8">
</span><span style="color:#f8f8f8">    </span>image<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8"> </span>nginx<span style="color:#f8f8f8">
</span><span style="color:#f8f8f8">    </span>container_name<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8"> </span>blog<span style="color:#f8f8f8">
</span><span style="color:#f8f8f8">    </span>volumes<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8">
</span><span style="color:#f8f8f8">      </span>-<span style="color:#f8f8f8"> </span><span style="color:#4e9a06">&#34;/etc/nginx/nginx.conf:/etc/nginx/nginx.conf&#34;</span><span style="color:#f8f8f8">
</span><span style="color:#f8f8f8">      </span>-<span style="color:#f8f8f8"> </span><span style="color:#4e9a06">&#34;/var/www/blog:/etc/nginx/html&#34;</span><span style="color:#f8f8f8">
</span><span style="color:#f8f8f8">    </span>networks<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8">
</span><span style="color:#f8f8f8">      </span>-<span style="color:#f8f8f8"> </span>reverse-proxy<span style="color:#f8f8f8">
</span><span style="color:#f8f8f8">    </span>environment<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8">
</span><span style="color:#f8f8f8">      </span>-<span style="color:#f8f8f8"> </span>VIRTUAL_PORT=<span style="color:#0000cf;font-weight:700">1234</span><span style="color:#f8f8f8">
</span><span style="color:#f8f8f8">      </span>-<span style="color:#f8f8f8"> </span>VIRTUAL_HOST=theconfused.me<span style="color:#f8f8f8">
</span><span style="color:#f8f8f8">      </span>-<span style="color:#f8f8f8"> </span>LETSENCRYPT_HOST=theconfused.me<span style="color:#f8f8f8">
</span><span style="color:#f8f8f8">      </span>-<span style="color:#f8f8f8"> </span>LETSENCRYPT_EMAIL=lingyihuu@gmail.com<span style="color:#f8f8f8">
</span><span style="color:#f8f8f8">
</span><span style="color:#f8f8f8">  </span>draggymail<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8">
</span><span style="color:#f8f8f8">    </span>restart<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8"> </span>always<span style="color:#f8f8f8">
</span><span style="color:#f8f8f8">    </span>build<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8"> </span><span style="color:#4e9a06">&#34;/var/www/draggymail&#34;</span><span style="color:#f8f8f8">
</span><span style="color:#f8f8f8">    </span>container_name<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8"> </span>draggymail<span style="color:#f8f8f8">
</span><span style="color:#f8f8f8">    </span>networks<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8">
</span><span style="color:#f8f8f8">      </span>-<span style="color:#f8f8f8"> </span>reverse-proxy<span style="color:#f8f8f8">
</span><span style="color:#f8f8f8">    </span>environment<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8">
</span><span style="color:#f8f8f8">      </span>-<span style="color:#f8f8f8"> </span>VIRTUAL_PORT=<span style="color:#0000cf;font-weight:700">1234</span><span style="color:#f8f8f8">
</span><span style="color:#f8f8f8">      </span>-<span style="color:#f8f8f8"> </span>VIRTUAL_HOST=draggymail.theconfused.me<span style="color:#f8f8f8">
</span><span style="color:#f8f8f8">      </span>-<span style="color:#f8f8f8"> </span>LETSENCRYPT_HOST=draggymail.theconfused.me<span style="color:#f8f8f8">
</span><span style="color:#f8f8f8">      </span>-<span style="color:#f8f8f8"> </span>LETSENCRYPT_EMAIL=lingyihuu@gmail.com<span style="color:#f8f8f8">
</span><span style="color:#f8f8f8"></span>networks<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8">
</span><span style="color:#f8f8f8">  </span>reverse-proxy<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8">
</span><span style="color:#f8f8f8">    </span>external<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8">
</span><span style="color:#f8f8f8">      </span>name<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8"> </span>reverse-proxy</code></pre></div><p>The blog service serves up my blog, which is what you're looking at right now. It just uses the <code>nginx</code> container. You can insert the nginx configuration by mounting the appropriate configuration file. The format for mounting volumes is</p><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">/path/on/host:/path/in/docker/container:options</code></pre></div><p>The <code>options</code> field is optional, it is where you can specify what docker is allowed to do with the mounted volume. <code>ro</code> stands for readonly, and <code>rw</code> gives the docker container permission to (yup, you guessed it) read and write.</p><p>The draggymail service builds and runs my NodeJS app. The filepath in <code>build</code> tells docker to look for the <code>Dockerfile</code> inside the folder, build the image, and run the container. This is so that I don't have to build the image separately every time.</p><p>Then just run <code>docker-compose up -d</code> to run your containers.</p><h2 id="handy-docker-commands">Handy Docker commands</h2><p>A few docker commands I found myself repeatedly searching up.</p><h4 id="building-an-image-with-a-dockerfile-in-the-current-directory">Building an image with a dockerfile in the current directory</h4><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">docker build -t image_name:tag_name .</code></pre></div><h3 id="running-a-docker-container">Running a docker container</h3><p>Simple command:</p><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">docker run image_name:tag_name</code></pre></div><p>A more complicated command:</p><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">docker run -d --name container_name -p <span style="color:#0000cf;font-weight:700">80</span>:80 -p <span style="color:#0000cf;font-weight:700">443</span>:443 --net network_name -v /path/of/file/in/host:/path/of/file/in/container image_name:tag_name</code></pre></div><ul><li><code>-d</code> detached mode</li><li><code>--name</code> specify the name you want to call this container</li><li><code>-p</code> ports mapping</li><li><code>--net</code> network to put it on</li><li><code>-v</code> volumes to mount</li></ul><h3 id="creating-a-network">Creating a network</h3><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">docker network create --driver bridge network_name</code></pre></div><p><code>--driver</code> driver to manage the network</p><h3 id="start-and-go-into-interactive-mode-of-last-created-container">Start and go into interactive mode of last created container</h3><p>(thanks to <a href="https://stackoverflow.com/a/37886136/3881923" target="_blank">this stackoverflow answer</a>)</p><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">docker start -a -i <span style="color:#4e9a06">`</span>docker ps -q -l<span style="color:#4e9a06">`</span> </code></pre></div><ul><li><code>docker start</code> start a container (requires name or ID)</li><li><code>-a</code> attach to container</li><li><code>-i</code> interactive mode</li><li><code>docker ps</code> List containers</li><li><code>-q</code> list only container IDs</li><li><code>-l</code> list only last created container</li></ul><h3 id="start-and-go-into-interactive-mode-of-a-specific-container">Start and go into interactive mode of a specific container</h3><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">docker <span style="color:#204a87">exec</span> -it container_name_or_id /bin/bash</code></pre></div><h3 id="remove-dangling-images">Remove dangling images</h3><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">docker rmi <span style="color:#204a87;font-weight:700">$(</span>docker images -qa -f <span style="color:#4e9a06">&#39;dangling=true&#39;</span><span style="color:#204a87;font-weight:700">)</span></code></pre></div><p>List all containers (running and exited):</p><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">docker ps -a</code></pre></div></div><hr class="gap-top"><div class="faded gap-top message">You can email me at lingyihuu(at)gmail.com if you have any comments, suggestions, or questions. I should respond promptly, because frankly I am not famous enough to be ignoring emails yet.</div><div class="faded gap-top"><a href="https://theconfused.me/" style="margin-right:2rem">&larr; home</a> <a href="https://theconfused.me/blog">&larr; blog archive</a></div></div></div><div class="" id="toc"></div><script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.1.1/tocbot.min.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.1.1/tocbot.css"><style>.is-active-link::before{background-color:var(--secondary-color)}</style><script type="text/javascript">null!==document.getElementById("toc")&&0!==document.getElementsByClassName("post-content").length&&tocbot.init({tocSelector:"#toc",contentSelector:".post-content",headingSelector:"h1, h2, h3"})</script></body></html>